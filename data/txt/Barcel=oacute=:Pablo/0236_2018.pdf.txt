Proceedings of the Twenty-Seventh International Joint Conference on Artiﬁcial Intelligence (IJCAI-18)

1707

First-OrderRewritabilityofFrontier-GuardedOntology-MediatedQueriesPabloBarcel´o1,GeraldBerger2,CarstenLutz3andAndreasPieris41MillenniumInstituteforFoundationalResearchonData&DCC,UniversityofChile2InstituteofLogicandComputation,TUWien3DepartmentofMathematicsandComputerScience,UniversityofBremen4SchoolofInformatics,UniversityofEdinburghAbstractWefocusonontology-mediatedqueries(OMQs)basedon(frontier-)guardedexistentialrulesand(unionsof)conjunctivequeries,andweinvesti-gatetheproblemofFO-rewritability,i.e.,whetheranOMQcanberewrittenasaﬁrst-orderquery.Weadopttwodifferentapproaches.Theﬁrstap-proachemploysstandardtwo-wayalternatingpar-itytreeautomata.Althoughitdoesnotleadtoatightcomplexitybound,itprovidesatransparentsolutionbasedonwidelyknowntools.Thesecondapproachreliesonasophisticatedautomatamodel,knownascostautomata.Thisallowsustoshowthatourproblemis2EXPTIME-complete.Inbothapproaches,weprovidesemanticcharacterizationsofFO-rewritabilitythatareofindependentinterest.1IntroductionOntology-baseddataaccess(OBDA)isasuccessfulappli-cationofKRRtechnologiesininformationmanagementsys-tems[Poggietal.,2008].Onepremiergoalistofacilitateaccesstodatathatisheterogeneousandincomplete.Thisisachievedviaanontologythatenrichestheuserquery,typi-callyaunionofconjunctivequeries,withdomainknowledge.Itturnedoutthattheontologyandtheuserquerycanbeseenastwocomponentsofonecompositequery,calledontology-mediatedquery(OMQ)[Bienvenuetal.,2014].TheproblemofansweringOMQsisthuscentraltoOBDA.Buildingontology-awaredatabasesystemsfromscratch,withsophisticatedoptimizationtechniques,isanon-trivialtaskthatrequiresagreateffort.AnimportantroutetowardspracticalimplementationofOMQansweringisthustouseconventionaldatabasemanagementsystems.Theproblemthatsuchsystemsareunawareofontologiescanbeaddressedbyqueryrewriting:theontologyOandthedatabasequeryqarecombinedintoanewqueryqO,theso-calledrewriting,whichgivesthesameanswerastheOMQconsistingofOandqoverallinputdatabases.ItisofcourseessentialthattherewritingqOisexpressedinalanguagethatcanbehan-dledbystandarddatabasesystems.Thetypicallanguagethatisconsideredinthissettingisﬁrst-order(FO)queries.AlthoughintheOMQsettingdescriptionlogics(DLs)areoftenusedformodelingontologies,itiswidelyacceptedthatforhandlingarbitraryarityrelationsinrelationaldatabasesitisconvenienttousetuple-generatingdependencies(TGDs),a.k.a.existentialrulesorDatalog±rules.Itisknown,how-ever,thatevaluationofrule-basedOMQsisundecidable[Cal`ıetal.,2013].ThishasledtoaﬂurryofactivityforidentifyingrestrictionsonTGDsthatleadtodecidability.Themainde-cidableclassesare(i)(frontier-)guardedTGDs[Bagetetal.,2011;Cal`ıetal.,2013],whichincludeslinearTGDs[Cal`ıetal.,2012a],(ii)acyclicsetsofTGDs[Faginetal.,2005],and(iii)stickysetsofTGDs[Cal`ıetal.,2012b].TherearealsoextensionsthatcaptureDatalog;seethesamereferences.ForOMQsbasedonlinearity,acyclicity,andstickiness,FO-rewritingsarealwaysguaranteedtoexist[Gottlobetal.,2014].Incontrast,thereare(frontier-)guardedOMQsthatareinherentlyrecursive,andthusnotexpressibleasaﬁrst-orderquery.Thisbringsustoourmainquestion:Canwecheckwhethera(frontier-)guardedOMQisFO-rewritable?NoticethatforOMQsbasedonmoreexpressiveclassesofTGDsthatcaptureDatalog,theanswertotheabovequestionisnegative,sincecheckingwhetheraDatalogqueryisFO-rewritableisanundecidableproblem.Actually,weknowthataDatalogqueryisFO-rewritableiffitisbounded[AjtaiandGurevich,1994],whiletheboundednessproblemforDatalogisundecidable[Gaifmanetal.,1993].TheabovequestionhasbeenstudiedforOMQlanguagesbasedonHornDLs,includingELandELI,which(uptoacertainnormalform)areaspecialcaseofguardedTGDs[Bi-envenuetal.,2013;2016;LutzandSabellek,2017].Moreprecisely,FO-rewritabilityissemanticallycharacterizedintermsoftheexistenceofcertaintree-shapedABoxes,whichinturnallowstheauthorstopinpointthecomplexityoftheproblembyemployingautomata-basedprocedures.AsusualintheDLcontext,schemasconsistonlyofunaryandbinaryrelations.However,inoursettingwehavetodealwithre-lationsofhigherarity.Thisindicatesthatthetechniquesde-visedforcheckingtheFO-rewritbilityofDL-basedOMQscannotbedirectlyappliedtorule-basedOMQs;thisisfurtherexplainedinSection3.Therefore,wedevelopnewsemanticcharacterizationsandproceduresthataresigniﬁcantlydiffer-entfromthoseforOMQsbasedondescriptionlogics.Proceedings of the Twenty-Seventh International Joint Conference on Artiﬁcial Intelligence (IJCAI-18)

1708

Ouranalysisaimstodevelopspeciallytailoredtechniquesthatallowustounderstandtheproblemofcheckingwhethera(frontier-)guardedOMQisFO-rewritable,andalsotopin-pointitscomputationalcomplexity.Ourplanofattackandresultscanbesummarizedasfollows:IWeﬁrstfocusonthesimplerOMQlanguagebasedonguardedTGDsandatomicqueries,and,inSection3,wepro-videacharacterizationofFO-rewritabilitythatformstheba-sisforapplyingtreeautomatatechniques.IWethenexploit,inSection4,standardtwo-wayalternat-ingparitytreeautomata.Inparticular,wereduceourproblemtotheproblemofcheckingtheﬁnitenessofthelanguageofanautomaton.ThereductionreliesonareﬁnedversionofthecharacterizationofFO-rewritabilityestablishedinSection3.Thisprovidesatransparentsolutiontoourproblembasedonstandardtools,butitdoesnotleadtoanoptimalresult.ITowardsanoptimalresult,weuse,inSection5,amoresophisticatedautomatamodel,knownascostautomata.ThisallowsustoshowthatFO-rewritabilityforOMQsbasedonguardedTGDsandatomicqueriesisin2EXPTIME,andinEXPTIMEforpredicatesofboundedarity.Ourapplicationofcostautomataisquitetransparent,which,asabove,reliesonareﬁnedversionofthecharacterizationofFO-rewritabilityestablishedinSection3.However,thecomplexityanalysisreliesonanintricateresultontheboundednessproblemforacertainclassofcostautomatafrom[Benediktetal.,2015].IFinally,inSection6,byusingtheresultsofSection5,weobtainourmainresults.WeshowthatFO-rewritabilityis2EXPTIME-completeforOMQsbasedonguardedTGDsandonfrontier-guardedTGDs,nomatterwhethertheactualqueriesareconjunctivequeries,unionsthereof,orthesim-pleatomicqueries.Thisremainstruewhenthearityofthepredicatesisboundedbyaconstant,withtheexceptionofguardedTGDsandatomicqueries,forwhichthecomplexitythendropstoEXPTIME-complete.Inprinciple,theprocedurebasedontreeautomataalsopro-videsconcreteFO-rewritingswhentheyexist,butitisnottailoredtowardsdoingthisinanefﬁcientway.Efﬁcientlyconstructingrewritingsisbeyondthescopeofthiswork.2PreliminariesBasics.LetC,N,andVbedisjoint,countablyinﬁnitesetsofconstants,(labeled)nulls,and(regular)variables,respec-tively.AschemaSisaﬁnitesetofrelationsymbols.ThewidthofS,denotedwd(S),isthemaximumarityamongallrelationsymbolsofS.WewriteR/ntodenotethattherela-tionsymbolRhasarityn≥0.Atermiseitheraconstant,null,orvariable.AnatomoverSisanexpressionoftheformR((cid:22)v),whereR∈Sisofarityn≥0and(cid:22)visann-tupleofterms.Afactisanatomwhoseargumentsareconstants.Databases.AnS-instanceisa(possiblyinﬁnite)setofatomsovertheschemaSthatcontainonlyconstantsandnulls,whileanS-databaseisaﬁnitesetoffactsoverS.Theactivedo-mainofaninstanceJ,denotedadom(J),consistsofalltermsoccurringinJ.ForX⊆adom(J),wedenotebyJ[X]thesubinstanceofJinducedbyX,i.e.,thesetofallfactsR((cid:22)a)with(cid:22)a⊆X.AtreedecompositionofaninstanceJisatu-pleδ=(T,(Xt)t∈T),whereT=(T,E)isa(directed)treewithnodesTandedgesE,and(Xt)t∈Tisacollectionofsub-setsofadom(J),calledbags,suchthat(i)ifR((cid:22)a)∈J,thenthereisv∈Tsuchthat(cid:22)a⊆Xv,and(ii)foralla∈adom(J),theset{v∈T|a∈Xv}inducesaconnectedsubtreeofT.ThewidthofδisthemaximumsizeamongallbagsXv(v∈T)minusone.Thetree-widthofJ,denotedtw(J),ismin{n|thereisatreedecompositionofwidthnofJ}.Conjunctivequeries.Aconjunctivequery(CQ)overSisaﬁrst-orderformulaoftheformq((cid:22)x):=∃(cid:22)yφ((cid:22)x,(cid:22)y),where(cid:22)xand(cid:22)yaretuplesofvariables,andφisaconjunctionofatomsR1((cid:22)v1)∧···∧Rm((cid:22)vm)overSthatmentionvariablesfrom(cid:22)x∪(cid:22)yonly.Thevariables(cid:22)xaretheanswervariablesofq((cid:22)x).If(cid:22)xisemptythenqisaBooleanCQ.Letvar(q)bethesetofvariablesoccurringinq.Asusual,theevaluationofCQsoverinstancesisdeﬁnedintermsofhomomorphisms.Aho-momorphismfromqtoJisamappingh:var(q)→adom(J)suchthatRi(h((cid:22)vi))∈Jforeach1≤i≤m.WewriteJ|=q((cid:22)a)toindicatethatthereissuchahomomorphismhsuchthath((cid:22)x)=(cid:22)a.Theevaluationofq((cid:22)x)overJ,denotedq(J),isthesetofalltuples(cid:22)asuchthatJ|=q((cid:22)a).Aunionofconjunctivequeries(UCQ)q((cid:22)x)overSisadisjunction∨ni=1qi((cid:22)x)ofCQsoverS.Theevaluationofq((cid:22)x)overJ,denotedq(J),isthesetoftuples∪1≤i≤nqi(J).WewriteJ|=q((cid:22)a)toindicatethatJ|=qi((cid:22)a)forsome1≤i≤n.LetCQbetheclassofconjunctivequeries,andUCQtheclassofUCQs.WealsowriteAQ0fortheclassofatomicqueriesoftheformP(),wherePisa0-arypredicate.Tuple-generatingdependencies.Atuple-generatingdepen-dency(TGD)(a.k.a.existentialrule)isaﬁrst-ordersentenceoftheformτ:∀(cid:22)x,(cid:22)y(φ((cid:22)x,(cid:22)y)→∃(cid:22)zψ((cid:22)x,(cid:22)z)),whereφandψareconjunctionsofatomsthatmentiononlyvariables.Forbrevity,wewriteφ((cid:22)x,(cid:22)y)→∃(cid:22)zψ((cid:22)x,(cid:22)z),andusecommain-steadof∧forconjoiningatoms.Weassumethateachvari-ableof(cid:22)xismentionedinψ.WecallφandψthebodyandheadoftheTGD,respectively.TheTGDτislogicallyequiv-alenttothesentence∀(cid:22)x(qφ((cid:22)x)→qψ((cid:22)x)),whereqφ((cid:22)x)andqψ((cid:22)x)aretheCQs∃(cid:22)yφ((cid:22)x,(cid:22)y)and∃(cid:22)zψ((cid:22)x,(cid:22)z),respectively.Thus,aninstanceJsatisﬁesτifqφ(J)⊆qψ(J).Also,Jsat-isﬁesasetofTGDsO,denotedJ|=O,ifJsatisﬁeseveryτ∈O.LetTGDbetheclassofﬁnitesetsofTGDs.Ontology-mediatedqueries.Anontology-mediatedquery(OMQ)isatripleQ=(S,O,q((cid:22)x)),whereSisa(non-empty)schema(thedataschema),OisasetofTGDs(theontology),andq((cid:22)x)isaUCQoverS∪sig(O),wheresig(O)isthesetofrelationsymbolsinO.NoticethattheontologyOcanintroducerelationsthatarenotinS;thisallowsustoenrichtheschemaofq((cid:22)x).WeincludeSinthespeciﬁcationofQtoemphasizethatQwillbeevaluatedoverS-databases,eventhoughOandq((cid:22)x)mayuseadditionalrelationsymbols.ThesemanticsofQisgivenintermsofcertainanswers.ThecertainanswerstoaUCQq((cid:22)x)w.r.t.anS-databaseD,andasetOofTGDs,isthesetofalltuples(cid:22)aofconstants,where|(cid:22)a|=|(cid:22)x|,suchthat(D,O)|=q((cid:22)a),i.e.,J|=q((cid:22)a)foreveryinstanceJ⊇DthatsatisﬁesO.WewriteD|=Q((cid:22)a)if(cid:22)aisacertainanswertoqw.r.t.DandO.Moreover,wesetQ(D):={(cid:22)a∈adom(D)|(cid:22)x||D|=Q((cid:22)a)}.Ontology-mediatedquerylanguages.Wewrite(C,Q)forProceedings of the Twenty-Seventh International Joint Conference on Artiﬁcial Intelligence (IJCAI-18)

1709

theclassofOMQs(S,O,q),whereOfallsintheclassofTGDsC,andqinthequerylanguageQ.Theevaluationprob-lemfor(TGD,UCQ),i.e.,givenaqueryQ∈(TGD,UCQ)withdataschemaS,anS-databaseD,and(cid:22)a∈adom(D)|(cid:22)x|,todecidewhetherD|=Q((cid:22)a),isundecidable;thisholdsevenfor(TGD,AQ0)[Cal`ıetal.,2013].Herewedealwithoneofthemostparadigmaticdecidablerestrictions,i.e.,guarded-ness.ATGDisguardedifithasabodyatom,calledguard,thatcontainsallthebodyvariables.LetGbetheclassofallﬁnitesetsofguardedTGDs.ATGDτiscalledfrontier-guardedifitsbodycontainsanatom,calledfrontier-guard,thatcontainsthefrontierofτ,i.e.,thebodyvariablesthatap-pearalsointhehead.WewriteFGfortheclassofallﬁnitesetsoffrontier-guardedTGDs.Roughly,theevaluationprob-lemfor(G,UCQ)and(FG,UCQ)isdecidablesinceGandFGadmittree-likeuniversalmodels[Cal`ıetal.,2013].First-orderrewritability.Aﬁrst-order(FO)queryoveraschemaSisa(function-free)FOformulaφ((cid:22)x),with(cid:22)xbeingitsfreevariables,thatusesonlyrelationsfromS.Theevalua-tionofφoveranS-databaseD,denotedφ(D),isthesetoftu-ples{(cid:22)a∈adom(D)|(cid:22)x||D|=φ((cid:22)a)};|=denotesthestandardnotionofsatisfactionforFO.AnOMQQ=(S,O,q((cid:22)x))isFO-rewritableifthereexistsa(ﬁnite)FOqueryφQ((cid:22)x)overSthatisequivalenttoQ,i.e.,foreveryS-databaseDitisthecasethatQ(D)=φQ(D).WecallφQ((cid:22)x)anFO-rewritingofQ.AfundamentaltaskforanOMQlanguage(C,Q),whereCisaclassofTGDsandQisaclassofqueries,isdecidingﬁrst-orderrewritability:PROBLEM:FORew(C,Q)INPUT:AnOMQQ∈(C,Q).QUESTION:IsitthecasethatQisFO-rewritable?First-orderrewritabilityof(FG;UCQ)-queries.Asshownbythefollowingexample,thereexist(G,CQ)queries(andthus,(FG,UCQ)queries)thatarenotFO-rewritable.Example1.ConsidertheOMQQ=(S,O,q)∈(G,CQ),whereS={S/3,A/1,B/1},OconsistsofS(x,y,z),A(z)→R(x,z),S(x,y,z),R(x,z)→R(x,y),andq=∃x,y,z(S(x,y,z)∧R(x,z)∧B(y)).Intuitively,anFO-rewritingofQshouldcheckfortheexistenceofasetofatoms{S(c,ai,ai−1)}1≤i≤k,amongothers,fork≥0.However,sincethereisnoupperboundfork,thiscannotbedoneviaaﬁniteFO-query,andthus,QisnotFO-rewritable.AproofthatQisnotFO-rewritableisgivenbelow.Ontheotherhand,thereare(frontier-)guardedOMQsthatareFO-rewritable;e.g.,theOMQobtainedfromthequeryQinExample1byaddingA(z)toqisFO-rewritablewith∃x,y,z(S(x,y,z)∧B(y)∧A(z))beinganFO-rewriting.3SemanticCharacterizationWeproceedtogiveacharacterizationofFO-rewritabilityofOMQsfrom(G,AQ0)intermsoftheexistenceofcertaintree-likedatabases.Ourcharacterizationisrelatedto,butdif-ferentfromcharacterizationsusedforOMQsbasedonDLssuchasELandELI[Bienvenuetal.,2013;2016].Thecharacterizationsin[Bienvenuetal.,2013;2016]es-sentiallystatethataunaryOMQQisFO-rewritableiffthereisaboundksuchthat,whenevertherootofatree-shapeddatabaseDisreturnedasananswertoQ,thenthisisalreadytruefortherestrictionofDuptodepthk.Theproofofthe(contrapositiveofthe)“onlyif”directionusesalocalityargu-ment:ifthereisnosuchboundk,thenthisiswitnessedbyaninﬁnitesequenceofdeeperanddeepertreedatabasesthates-tablishnon-localityofQ.ForguardedTGDs,wewouldhavetoreplacetree-shapeddatabaseswithdatabasesofboundedtree-width.However,increasingdepthoftreedecompositionsdoesnotcorrespondtoincreasingdistanceintheGaifmangraph,andthus,doesnotestablishnon-locality.Wethereforedepartfromimposingaboundonthedepth,andinsteadweimposeaboundonthenumberoffacts,asdetailedbelow.Itisalsointerestingtonotethat,whileitisimplicitin[Bi-envenuetal.,2016]thatanOMQbasedonELIandCQsisFO-rewritableiffitisGaifmanlocal,thereexistsanOMQfrom(G,CQ)thatisGaifmanlocal,butnotFO-rewritable.SuchanOMQistheoneobtainedfromthequeryQgiveninExample1,byremovingtheexistentialquantiﬁcationonthevariablexintheCQq,i.e.,convertingqintoaunaryCQ.Theorem1.ConsideranOMQQ∈(G,AQ0)withdataschemaS.Thefollowingareequivalent:1.QisFO-rewritable.2.Thereisak≥0suchthat,foreveryS-databaseDoftree-widthatmostwd(S)−1,ifD|=Q,thenthereisaD′⊆DwithatmostkfactssuchthatD′|=Q.For(1)⇒(2)weexploitthefactthat,ifQ∈(G,AQ0)isFO-rewritable,thenitcanbeexpressedasaUCQqQ.ThisfollowsfromthefactthatOMQsfrom(G,AQ0)arepreservedunderhomomorphisms[Bienvenuetal.,2014],andRoss-man’sTheoremstatingthatanFOqueryispreservedunderhomomorphismsoverﬁniteinstancesiffitisequivalenttoaUCQ[Rossman,2008].Itistheneasytoshowthat(2)holdswithkbeingthesizeofthelargestdisjunctoftheUCQqQ.For(2)⇒(1),weusethefactthat,ifthereisanS-databaseDthatentailsQ,thenthereexistsoneoftree-widthatmostwd(S)−1thatentailsQ,andcanbemappedtoD.ThenextexampleillustratesTheorem1.Example2.ConsidertheOMQQ=(S,O,P)∈(G,AQ0),whereS={S/3,A/1,B/1},andOconsistsoftheTGDsgiveninExample1plustheguardedTGDS(x,y,z),R(x,z),B(y)→P,whichisessentiallytheCQqfromExample1.Itiseasytoverifythat,foranarbitraryk≥0,theS-databaseDk={A(a0),S(c,a1,a0),...,S(c,ak−1,ak−2),B(ak−1)}oftree-widthwd(S)−1=2issuchthatDk|=Q,butforeveryD′⊂Dkwithatmostkfacts,D′̸|=Q.Thus,byTheorem1,QisnotFO-rewritable.Proceedings of the Twenty-Seventh International Joint Conference on Artiﬁcial Intelligence (IJCAI-18)

1710

4AlternatingTreeAutomataApproachInthissection,weexploitthewell-knownalgorithmictooloftwo-wayalternatingparitytreeautomata(2ATA)overﬁnitetreesofboundeddegree(see,e.g.,[Cosmadakisetal.,1988]),andprovethatFORew(G,AQ0)canbesolvedinelementarytime.Althoughthisresultisnotoptimal,ourconstructionprovidesatransparentsolutiontoFORew(G,AQ0)basedonstandardtools.Thisisincontrastwithpreviousstudiesoncloselyrelatedproblemsforguardedlogics,inwhichallel-ementaryboundsheavilyrelyontheuseofintricateresultsoncostautomata[Blumensathetal.,2014;Benediktetal.,2015].Wealsoapplysuchresultslater,butonlyinordertopinpointtheexactcomplexityofFORew(G,AQ0).TheideabehindoursolutiontoFORew(G,AQ0)is,givenaqueryQ∈(G,AQ0),todevisea2ATABQsuchthatQisFO-rewritableiffthelanguageacceptedbyBQisﬁnite.ThisisastandardideawithrootsinthestudyoftheboundednessproblemformonadicDatalog(seee.g.,[Vardi,1992]).Inparticular,ourmainresultestablishesthefollowing:Theorem2.LetQ∈(G,AQ0)withdataschemaS.Thereisa2ATABQontreesofdegreeatmost2wd(S)suchthatQisFO-rewritableiffthelanguageofBQisﬁnite.ThestatesetofBQisofdoubleexponentialsizeinwd(S),andofexponentialsizein|S∪sig(O)|.Furthermore,BQcanbeconstructedindoubleexponentialtimeinthesizeofQ.AsacorollarytoTheorem2weobtainthefollowingresult:Corollary3.FORew(G,AQ0)isin3EXPTIME,andin2EX-PTIMEforpredicatesofboundedarity.FromTheorem2,tocheckwhetheraqueryQ∈(G,AQ0)isFO-rewritable,itsufﬁcestocheckthatthelanguageofBQisﬁnite.ThelatterisdonebyﬁrstconvertingBQintoanon-deterministicbottom-uptreeautomatonB′Q;see,e.g.,[Vardi,1998].Thisincursanexponentialblowup,andthus,B′Qhastripleexponentiallymanystates.WethenchecktheﬁnitenessofthelanguageofB′QinpolynomialtimeinthesizeofB′Qbyapplyingastandardreachabilityanalysis;see[Vardi,1992].Forpredicatesofboundedarity,asimilarargumentasaboveprovidesadoubleexponentialtimeupperbound.IntherestofSection4weexplaintheproofofTheorem2.Theintuitiveideaistoconstructa2ATABQwhoselanguagecorrespondstosuitableencodingsofdatabasesDofboundedtree-widththat“minimally”satisfyQ,i.e.,D|=Q,butifweremoveanyatomfromD,thenQisnolongersatisﬁed.Areﬁnedsemanticcharacterization.Inordertoapplyanapproachbasedon2ATA,itisessentialtorevisitthesemanticcharacterizationprovidedbyTheorem1.Tothisend,weneedtointroducesomeauxiliaryterminology.LetDbeadatabase,andδ=(T,(Xv)v∈T),whereT=(T,E),atreedecompositionofD.Anadornmentofthepair(D,δ)isafunctionη:T→2Dsuchthatη(v)⊆D[Xv]forallv∈T,and∪v∈Tη(v)=D.Therefore,thepair(δ,η)canbeviewedasarepresentationofthedatabaseDalongwithatreedecompositionofit.Fortheintendedcharacterization,itisimportantthatthisrepresentationisfreeofredundancies,formalizedasfollows.Wesaythatδisη-simpleif|η(v)|≤1forallv∈T,andnon-emptyη-labelsareunique,thatis,η(v)̸=η(w)foralldistinctv,w∈Twithη(v)andη(w)non-empty.Nodesv∈Twithη(v)empty,calledwhitefromnowon,arerequiredsincewemightnothavea(unique!)factavailabletolabelthem.Note,though,thatwhitenodesvarestillassociatedwithanon-emptysetofconstantsfromDviaXv.Allothernodesarecalledblack.Whileδbeingη-simpleavoidsredundanciesthatareduetoafactoccurringinthelabelofmultipleblacknodes,additionalredundanciesmayarisefromtheinﬂationaryuseofwhitenodes.Wesaythatanodev∈Tisη-well-coloredifitisblack,orithasatleasttwosuccessorsandallitssuccessorsareη-well-colored.Wesaythatδisη-well-coloredifeverynodeinTisη-well-colored.Forexample,δisnotη-well-coloredifithasawhiteleaf,orifithasawhitenodeanditssinglesuccessorisalsowhite.Informally,requiringδtobeη-well-coloredmakesitimpossibletoblowupthetreebyintroducingwhitenodeswithoutintroducingblacknodes.Fori∈{1,2},letDibeadatabase,δiatreedecompositionofDi,andηianadorn-mentof(Di,δi).Wesaythat(D1,δ1,η1)and(D2,δ2,η2)areisomorphicifthelattercanbeobtainedfromtheformerbyconsistenlyrenamingconstantsinD1andtreenodesinδ1.WearenowreadytorevisitthecharacterizationofFO-rewritabilityforOMQsfrom(G,AQ0)giveninTheorem1.Theorem4.ConsideranOMQQ∈(G,AQ0)withdataschemaS.Thefollowingareequivalent:1.Condition2fromTheorem1issatisﬁed.2.Thereareﬁnitelymanynon-isomorphictriples(D,δ,η),whereDisanS-database,δatreedecompositionofDofwidthatmostwd(S)−1,andηanadornmentof(D,δ),suchthat(a)δisη-simpleandη-well-colored,(b)D|=Q,and(c)foreveryα∈D,itisthecasethatD\{α}̸|=Q.Devisingautomata.Weproceedtodiscusshowthe2ATAannouncedinTheorem2isconstructed.ConsideranOMQQ=(S,O,P)from(G,AQ0).Ourgoalistodeviseanau-tomatonBQwhoselanguageisﬁniteiffCondition2fromTheorem4issatisﬁed.ByTheorems1and4,QisthenFO-rewritableiffthelanguageofBQisﬁnite.The2ATABQwillbetheintersectionofseveralautomatathatcheckthepropertiesstatedinitem2ofTheorem4.Butﬁrstweneedtosayafewwordsabouttreeencodings.Let(cid:0)beaﬁnitealphabet,andlet(N\{0})∗denotethesetofallﬁnitewordsofpositiveintegers,includingtheemptyword.Aﬁnite(cid:0)-labeledtreeisapartialfunctiont:(N\{0})∗→(cid:0)suchthatthedomainoftisﬁniteandpreﬁx-closed.More-over,ifv·ibelongstothedomainoft,thenv·(i−1)alsobelongstothedomainoft.Infact,theelementsinthedomainoftidentifythenodesofthetree.ItcanbeshownthatanS-databaseD,atreedecompositionδofDofwidthw−1,andanadornmentηof(D,δ),canbeencodedasa(cid:0)S,w-labeledtreetofdegreeatmost2w,where(cid:0)S,wisanalphabetofsizedoubleexponentialinwandexponentialinS,suchthateachnodeofδcorrespondstoexactlyonenodeoftandviceversa.AlthougheveryDcanbeencodedintoa(cid:0)S,w-labeledtreet,theconverseisnottrueingeneral.However,itispossibletoProceedings of the Twenty-Seventh International Joint Conference on Artiﬁcial Intelligence (IJCAI-18)

1711

deﬁnecertainsyntacticconsistencyconditionssuchthateveryconsistent(cid:0)S,w-labeledtcanbedecodedintoanS-database,denotedJtK,whosetree-widthisatmostw.Wearegoingtoabbreviatethealphabet(cid:0)S,wd(S)by(cid:0)S.Lemma5.Thereisa2ATACSthatacceptsa(cid:0)S-labeledtreetifftisconsistent.ThenumberofstatesofCSisconstant.CScanbeconstructedinpolynomialtimeinthesizeof(cid:0)S.Sincea(cid:0)S-labeledtreeincorporatestheinformationaboutanadornment,thenotionsofbeingwell-coloredandsimplecanbenaturallydeﬁnedfor(cid:0)S-labeledtrees.Then:Lemma6.Thereisa2ATARSthatacceptsaconsistent(cid:0)S-labeledtreeiffitiswell-coloredandsimple.ThenumberofstatesofRSisexponentialinwd(S)andlinearin|S|.RScanbeconstructedinpolynomialtimeinthesizeof(cid:0)S.Concerningproperty2(b)ofTheorem4,wecandevisea2ATAthatacceptsthosetreeswhosedecodingsatisﬁesQ:Lemma7.Thereisa2ATAAQthatacceptsaconsistent(cid:0)S-labeledtreeiffJtK|=Q.ThenumberofstatesofAQisex-ponentialinwd(S)andlinearin|S∪sig(O)|.AQcanbeconstructedindoubleexponentialtimeinthesizeofQ.Thecrucialtaskistocheckcondition2(c)ofTheorem4,whichstatesthekeyminimalitycriterion.Unfortunately,thisinvolvesanextraexponentialblowup:Lemma8.Thereisa2ATAMQthatacceptsaconsistent(cid:0)S-labeledtreetiffJtK\{α}̸|=Qforallα∈JtK.ThestatesetofMQisofdoubleexponentialsizeinwd(S),andofexponentialsizein|S∪sig(O)|.Furthermore,MQcanbeconstructedindoubleexponentialtimeinthesizeofQ.LetusbrieﬂyexplainhowMQisconstructed.Thiswillexposethesourceoftheextraexponentialblowup,whichpre-ventsusfromobtaininganoptimalcomplexityupperboundforFORew(G,AQ0).Weﬁrstconstructa2ATADQthatrunson(cid:3)S-labeledtrees,where(cid:3)Sisanalphabetthatextends(cid:0)Swithauxiliarysymbolsthatallowustotagsomefactsintheinputtree.Inparticular,DQacceptsatreetifftisconsis-tent,thereisatleastonetaggedfact,andJtK−|=QwhereJtK−isobtainedfromJtKbyremovingthetaggedfacts.Hav-ingDQinplace,wecanthenconstructa2ATA∃DQthatacceptsa(cid:0)S-labeledtreetifthereisawaytotagsomeofitsfactssoastoobtaina(cid:3)S-labeledtreet′withJt′K−|=Q.ThisisachievedbyapplyingtheprojectionoperatoronDQ.Sincefor2ATAsprojectioninvolvesanexponentialblowupandDQalreadyhasexponentiallymanystates,∃DQhasdou-bleexponentiallymany.ItshouldbeclearnowthatMQisthecomplementof∃DQ,andwerecallthatcomplementationof2ATAscanbedoneinpolynomialtime.ThedesiredautomatonBQisobtainedbyintersectingthe2ATAsinLemmas5to8.Sincetheintersectionof2ATAisfeasibleinpolynomialtime,BQcanbeconstructedindoubleexponentialtimeinthesizeofQ.5CostAutomataApproachWeproceedtostudyFORew(G,AQ0)usingthemoresophis-ticatedmodelofcostautomata.ThisallowsustoimprovethecomplexityoftheproblemobtainedinCorollary3asfollows:Theorem9.FORew(G,AQ0)isin2EXPTIME,andinEXP-TIMEforpredicatesofboundedarity.Asinthepreviousapproach,wedevelopasemanticchar-acterizationthatreliesonaminimalitycriterionfortreesac-ceptedbycostautomata.Theextrafeaturesprovidedbycostautomataallowustodealwithsuchaminimalitycriterioninamoreefﬁcientwaythanstandard2ATA.Whileourapplica-tionofcostautomataistransparent,thecomplexityanalysisreliesonanintricateresultontheboundednessproblemforacertainclassofcostautomatafrom[Benediktetal.,2015].Beforeweproceedfurther,letusprovideabriefoverviewofthecostautomatamodelthatwearegoingtouse.Costautomatamodels.Costautomataextendtraditionalau-tomatabyprovidingcountersthatcanbemanipulatedateachtransition.InsteadofassigningaBooleanvaluetoeachin-putstructure(indicatingwhetheritisacceptedornot),theseautomataassignavaluefromN∞:=N∪{∞}toeachinput.Here,wefocusoncostautomatathatworkonﬁnitetreesofunboundeddegree,andallowfortwo-waymovements;infact,theautomatathatweneedarethosethatextend2ATAoverﬁnitetreeswithasinglecounter.TheoperationofsuchanautomatonAoneachinputtwillbeviewedasatwo-playercostgameG(A,t)betweenplayersEveandAdam.Recallthattheacceptanceofaninputtreeforaconventional2ATAcanbeformalizedviaatwo-playergameaswell.How-ever,insteadoftheparityacceptanceconditionfor2ATA,playsinthecostgamebetweenEveandAdamwillbeas-signedcosts,andthecostautomatonspeciﬁesviaanobjectivewhetherEve’sgoalistominimizeormaximizethatcost.Incaseofaminimizing(resp.,maximizing)objective,astrategyξofEveinthecostgameG(A,t)isn-winningifanyplayofAdamconsistentwithξhascostatmostn(resp.,atleastn).Givenaninputtreet,onethendeﬁnesthevalueoftinAasJAK(t):=op{n|Evehasann-winningstrategyinG(A,t)},whereop=inf(resp.,op=sup)incaseEve’sobjectiveistominimize(resp.,maximize).Therefore,JAKdeﬁnesafunc-tionfromthedomainofinputtreestoN∞.Wecallfunctionsofthattypecostfunctions.Akeypropertyofsuchfunctionsisboundedness.WesaythatJAKisboundedifthereexistsann∈NsuchthatJAK(t)≤nforeveryinputtreet.Weemployautomatawithasinglecounter,whereEve’sobjectiveistominimizethecost,whilesatisfyingtheparitycondition.Suchanautomatonisknownintheliteratureasdist∧parity-automaton[Benediktetal.,2015].Tonavigateinthetree,itmayusethedirections{0,↕},where0indi-catesthattheautomatonshouldstayinthecurrentnode,and↕meansthattheautomatonmaymovetoanarbitraryneigh-boringnode,includingtheparent.Forthistypeofautomaton,wecandecidewhetheritscostfunctionisbounded[Benediktetal.,2015;ColcombetandFijalkow,2016].Asusual,∥A∥denotesthesizeofA.Then:Theorem10.Thereisapolynomialfsuchthat,foreverydist∧parity-automatonAusingpriorities{0,1}forthepar-ityacceptancecondition,theboundednessforJAKisdecid-ableintime∥A∥f(m),wheremisthenumberofstatesofA.Proceedings of the Twenty-Seventh International Joint Conference on Artiﬁcial Intelligence (IJCAI-18)

1712

OurgoalistoreduceFORew(G,AQ0)totheboundednessproblemfordist∧parity-automata.Areﬁnedsemanticcharacterization.WeﬁrstneedtorevisitthesemanticcharacterizationprovidedbyTheorem1.ConsideranS-databaseD,andaqueryQ=(S,O,P)∈(G,AQ0).LetkQ:=|S∪sig(O)|·ww,wherew:=wd(S∪sig(O)).AderivationtreeforDandQisalabeledkQ-arytreeT,withηbeinganodelabelingfunctionthatassignsfactsR((cid:22)a),whereR∈S∪sig(O)and(cid:22)a⊆adom(D),toitsnodes,thatsatisﬁesthefollowingconditions:1.FortherootnodevofT,η(v)=P.2.ForeachleafnodevofT,η(v)∈D.3.Foreachnon-leafnodevofT,withu1,...,ukbeingitschildren,({η(u1),...,η(uk)},O)|=η(v).Roughly,Tdescribeshowthe0-arypredicatePcanbeen-tailedfromDandO.Infact,itiseasytoshowthatD|=QiffthereisaderivationtreeforDandQ.TheheightofT,de-notedhgt(T),isthemaximumlengthofabranchinT,i.e.,ofapathfromtheroottoaleafnode.AssumingthatD|=Q,thecostofDw.r.t.Q,denotedcost(D,Q),isdeﬁnedasmin{hgt(T)|TisaderivationtreeforDandQ},whilethecostofQ,denotedcost(Q),isdeﬁnedassup{cost(D,Q)|D|=Q,DisanS-databasewithtw(D)≤wd(S)−1}.Inotherwords,thecostofQistheleastupperboundoftheheightoverallderivationtreesforallS-databasesDoftree-widthatmostwd(S)−1suchthatD|=Q.Ifthereisnosuchadatabase,thenthecostofQiszerosincesup∅:=0.Actually,cost(Q)=0indicatesthatQisunsatisﬁable,whichinturnmeansthatQistriviallyFO-rewritable.HavingthenotionofthecostofanOMQfrom(G,AQ0)inplace,itshouldnotbedifﬁculttoseehowwecanreﬁnethesemanticcharacterizationprovidedbyTheorem1.Theorem11.ConsideranOMQQ∈(G,AQ0)withdataschemaS.Thefollowingareequivalent:1.Condition2fromTheorem1issatisﬁed.2.cost(Q)isﬁnite.Devisingautomata.WebrieﬂydescribehowwecanusecostautomatainordertodeviseanalgorithmforFORew(G,AQ0)thatrunsindoubleexponentialtime.ConsideranOMQQ=(S,O,P)∈(G,AQ0).Ourgoalistodeviseadist∧parity-automatonBQsuchthatthecostfunctionJBQKisboundediffcost(Q)isﬁnite.Therefore,byTheorems1and11,tocheckwhetherQisFO-rewritablewesimplyneedtocheckifJBQKisbounded,which,byThe-orem10,canbedoneinexponentialtimeinthesizeofBQ.Theinputtreestoourautomatawillbeoverthesamealphabet(cid:0)Sthatisusedtoencodetree-likeS-databasesinSection4.Recallthatforadist∧parity-automatonA,thecostfunctionJAKisboundedoveracertainclassCoftreesifthereisann∈NsuchthatJAK(t)≤nforeveryinputtreet∈C.Then:Lemma12.Thereisadist∧parity-automatonHQsuchthatJHQKisboundedoverconsistent(cid:0)S-labeledtreesiffcost(Q)isﬁnite.ThenumberofstatesofHQisexponentialinwd(S),andpolynomialin|S∪sig(O)|.Moreover,HQcanbecon-structedindoubleexponentialtimeinthesizeofQ.TheautomatonHQisbuiltinsuchawaythat,onaninputtreet,Evehasann-winningstrategyinG(HQ,t)iffthereisaderivationtreeforJtKandQofheightatmostn.Thus,Evetriestoconstructderivationtreesofminimalheight.Thecounterisusedtocounttheheightofthederivationtree.Havingthisautomatoninplace,wecannowcompletetheproofofTheorem9.Thedesireddist∧parity-automatonBQisdeﬁnedasC′S∩HQ,whereC′Sissimilartothe2ATACS(inLemma5)thatchecksforconsistencyof(cid:0)S-labeledtreesofboundeddegree.NoticethatC′Sisessentiallyadist∧parity-automatonthatassignszero(resp.,∞)toinputtreesthatareconsistent(resp.,inconsistent),andthus,C′S∩HQiswell-deﬁned.Sincetheintersectionofdist∧parity-automataisfeasibleinpolynomialtime,Lemma5andLemma12implythatBQhasexponentiallymanystates,anditcanbecon-structedindoubleexponentialtime.Lemma12impliesalsothatJBQKisboundediffcost(Q)isﬁnite.ItremainstoshowthattheboundednessofJBQKcanbecheckedindoubleex-ponentialtime.ByTheorem10,thereisapolynomialfsuchthatthelattertaskcanbecarriedoutintime∥BQ∥f(m),wheremisthenumberofstatesofBQ,andtheclaimfollows.Forpredicatesofboundedarity,weprovideasimilaranalysis.6Frontier-GuardedOMQsThegoalofthissectionistoshowthefollowingresult:Theorem13.Itholdsthat:•FORew(FG,Q)is2EXPTIME-complete,foreachQ∈{UCQ,CQ,AQ0},evenforpredicatesofboundedarity.•FORew(G,Q)is2EXPTIME-complete,foreachQ∈{UCQ,CQ},evenforpredicatesofboundedarity.•FORew(G,AQ0)is2EXPTIME-complete.Moreover,forpredicatesofboundedarityitisEXPTIME-complete.Lowerbounds.The2EXPTIME-hardnessintheﬁrstandtheseconditemsisinheritedfrom[Bienvenuetal.,2016],whereitisshownthatdecidingFO-rewritabilityforOMQsbasedonELIandCQsis2EXPTIME-hard.Forthe2EXP-TIME-hardnessinthethirditemweexploitthefactthatcon-tainmentforOMQsfrom(G,AQ0)is2EXPTIME-hard,eveniftheright-handsidequeryisFO-rewritable;thisisimplicitin[Barcel´oetal.,2014].Finally,theEXPTIME-hardnessinthethirditemisinheritedfrom[Bienvenuetal.,2013],whereitisshownthatdecidingFO-rewritabilityforOMQsbasedonELandatomicqueriesisEXPTIME-hard.Upperbounds.Thefactthatforpredicatesofboundedar-ityFORew(G,AQ0)isinEXPTIMEisobtainedfromTheo-rem9.ItremainstoshowthatFORew(FG,UCQ)isin2EX-PTIME.WereduceFORew(FG,UCQ)inpolynomialtimetoFORew(FG,AQ0),andthenshowthatthelatterisin2EXP-TIME.Thisreductionreliesonaconstructionfrom[Bienvenuetal.,2016],whichallowsustoreduceFORew(FG,UCQ)toProceedings of the Twenty-Seventh International Joint Conference on Artiﬁcial Intelligence (IJCAI-18)

1713

FORew(FG,UBCQ)withUBCQbeingtheclassofunionofBooleanCQs,andthefactthataBooleanCQcanbeseenasafrontier-guardedTGD.ToshowthatFORew(FG,AQ0)isin2EXPTIME,wereduceittoFORew(G,AQ0),andthenapplyTheorem9.Thisreliesontreeiﬁcation,andisinspiredbyatranslationofguardednegationﬁxed-pointsentencesintoguardedﬁxed-pointsentences[B´ar´anyetal.,2015].Ourre-ductionmaygiverisetoexponentiallymanyguardedTGDs,butthearityisincreasedonlypolynomially.Sincetheproce-dureforFORew(G,AQ0)providedbyTheorem9isdoubleexponentialonlyinthearityoftheschematheclaimfollows.7FutureWorkTheprocedurebasedon2ATAprovidesanFO-rewritingincasetheinputOMQadmitsone,butitisnottailoredtowardsdoingthisinanefﬁcientway.Ournextstepistoexploitthetechniquesdevelopedinthisworkfordevisingpracticallyef-ﬁcientalgorithmsforconstructingFO-rewritings.AcknowledgementsBarcel´oisfundedbytheMillenniumInstituteforFounda-tionalResearchonDataandFondecytgrant1170109.BergerisfundedbytheFWFprojectW1255-N23andaDOCfel-lowshipoftheAustrianAcademyofSciences.LutzisfundedbytheERCgrant647289“CODA”.PierisisfundedbytheEPSRCprogrammegrantEP/M025268/“VADA”.References[AjtaiandGurevich,1994]Mikl´osAjtaiandYuriGurevich.Datalogvsﬁrst-orderlogic.J.Comput.Syst.Sci.,49(3):562–588,1994.[Bagetetal.,2011]Jean-Franc¸oisBaget,MichelLecl`ere,Marie-LaureMugnier,andEricSalvat.Onruleswithex-istentialvariables:Walkingthedecidabilityline.Artif.In-tell.,175(9-10):1620–1654,2011.[B´ar´anyetal.,2015]VinceB´ar´any,BaldertenCate,andLucSegouﬁn.Guardednegation.J.ACM,62(3):22:1–22:26,2015.[Barcel´oetal.,2014]PabloBarcel´o,MiguelRomero,andMosheY.Vardi.Doesqueryevaluationtractabilityhelpquerycontainment?InPODS,pages188–199,2014.[Benediktetal.,2015]MichaelBenedikt,BaldertenCate,ThomasColcombet,andMichaelVandenBoom.Thecomplexityofboundednessforguardedlogics.InLICS,pages293–304,2015.[Bienvenuetal.,2013]MeghynBienvenu,CarstenLutz,andFrankWolter.First-orderrewritabilityofatomicqueriesinhorndescriptionlogics.InIJCAI,2013.[Bienvenuetal.,2014]MeghynBienvenu,BaldertenCate,CarstenLutz,andFrankWolter.Ontology-baseddataac-cess:Astudythroughdisjunctivedatalog,CSP,andMM-SNP.ACMTrans.DatabaseSyst.,39(4):33:1–33:44,2014.[Bienvenuetal.,2016]MeghynBienvenu,PeterHansen,CarstenLutz,andFrankWolter.Firstorder-rewritabilityandcontainmentofconjunctivequeriesinhorndescriptionlogics.InIJCAI,pages965–971,2016.[Blumensathetal.,2014]AchimBlumensath,MartinOtto,andMarkWeyer.Decidabilityresultsfortheboundednessproblem.LogicalMethodsinComputerScience,10(3),2014.[Cal`ıetal.,2012a]AndreaCal`ı,GeorgGottlob,andThomasLukasiewicz.Ageneraldatalog-basedframeworkfortractablequeryansweringoverontologies.J.WebSem.,14:57–83,2012.[Cal`ıetal.,2012b]AndreaCal`ı,GeorgGottlob,andAn-dreasPieris.Towardsmoreexpressiveontologylan-guages:Thequeryansweringproblem.Artif.Intell.,193:87–128,2012.[Cal`ıetal.,2013]AndreaCal`ı,GeorgGottlob,andMichaelKifer.Tamingtheinﬁnitechase:Queryansweringun-derexpressiverelationalconstraints.J.Artif.Intell.Res.,48:115–174,2013.[ColcombetandFijalkow,2016]ThomasColcombetandNathana¨elFijalkow.Thebridgebetweenregularcostfunctionsandomega-regularlanguages.InICALP,pages126:1–126:13,2016.[Cosmadakisetal.,1988]StavrosS.Cosmadakis,HaimGaifman,ParisC.Kanellakis,andMosheY.Vardi.De-cidableoptimizationproblemsfordatabaselogicprograms(preliminaryreport).InSTOC,pages477–490,1988.[Faginetal.,2005]RonaldFagin,PhokionG.Kolaitis,Ren´eeJ.Miller,andLucianPopa.Dataexchange:seman-ticsandqueryanswering.Theor.Comput.Sci.,336(1):89–124,2005.[Gaifmanetal.,1993]HaimGaifman,HarryG.Mairson,YehoshuaSagiv,andMosheY.Vardi.Undecidableop-timizationproblemsfordatabaselogicprograms.J.ACM,40(3):683–713,1993.[Gottlobetal.,2014]GeorgGottlob,GiorgioOrsi,andAn-dreasPieris.Queryrewritingandoptimizationforontolog-icaldatabases.ACMTrans.DatabaseSyst.,39(3):25:1–25:46,2014.[LutzandSabellek,2017]CarstenLutzandLeifSabellek.Ontology-mediatedqueryingwiththedescriptionlogicEL:trichotomyandlineardatalogrewritability.InIJCAI,pages1181–1187,2017.[Poggietal.,2008]AntonellaPoggi,DomenicoLembo,DiegoCalvanese,GiuseppeDeGiacomo,MaurizioLenz-erini,andRiccardoRosati.Linkingdatatoontologies.J.DataSemantics,10:133–173,2008.[Rossman,2008]BenjaminRossman.Homomorphismpreservationtheorems.J.ACM,55(3):15:1–15:53,2008.[Vardi,1992]MosheY.Vardi.Automatatheoryfordatabasetheoreticans.InTheoreticalStudiesinComputerScience,pages153–180,1992.[Vardi,1998]MosheY.Vardi.Reasoningaboutthepastwithtwo-wayautomata.InICALP,pages628–641,1998.